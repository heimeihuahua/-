<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®è½¬æ¢å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .upload-section {
            padding: 40px;
            text-align: center;
        }
        
        .upload-area {
            border: 3px dashed #4facfe;
            border-radius: 10px;
            padding: 60px 20px;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        .upload-area:hover {
            border-color: #667eea;
            background: #e9ecef;
            transform: translateY(-2px);
        }
        
        .upload-area.dragover {
            border-color: #667eea;
            background: #e3f2fd;
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 48px;
            color: #4facfe;
            margin-bottom: 15px;
        }
        
        .file-input {
            display: none;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            margin: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .result-section {
            padding: 20px;
            display: none;
        }
        
        .table-container {
            overflow-x: auto;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        tr:hover {
            background: #f5f5f5;
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: 500;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .instructions {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .instructions h3 {
            color: #1976d2;
            margin-bottom: 10px;
        }
        
        .instructions ul {
            margin-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 5px;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .upload-section {
                padding: 20px;
            }
            
            th, td {
                padding: 8px 10px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æ•°æ®è½¬æ¢å·¥å…·</h1>
            <p>BIO-TD-BJ-ARD</p>
        </div>
        
        <div class="instructions">
            <h3>ä½¿ç”¨è¯´æ˜ï¼š</h3>
            <ul>
                <li>ä¸Šä¼ åŒ…å«Sample_IDï¼ŒSample_Nameï¼ŒMeasured_Concentrationï¼ŒProject_IDï¼ŒTask_Nameï¼ŒParameterï¼ŒResultValueåˆ—çš„Excelæ–‡ä»¶</li>
                <li>å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»yuqi1.zhang@beonemed.comã€‚</li>
            </ul>
        </div>
        
        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“</div>
                <h3>ç‚¹å‡»æˆ–æ‹–æ‹½Excelæ–‡ä»¶åˆ°æ­¤åŒºåŸŸ</h3>
                <p>æ”¯æŒ .xlsx å’Œ .xls æ ¼å¼</p>
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
            </div>
            <button class="btn" onclick="processFile()" id="processBtn" disabled>å¼€å§‹è½¬æ¢</button>
            <button class="btn" onclick="downloadExcel()" id="downloadBtn" disabled>ä¸‹è½½ç»“æœ</button>
        </div>
        
        <div id="status" class="status info" style="display: none;"></div>
        
        <div class="result-section" id="resultSection">
            <h3>è½¬æ¢ç»“æœé¢„è§ˆ</h3>
            <div class="table-container">
                <table id="resultTable">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let workbook = null;
        let convertedData = null;
        
        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
            uploadArea.addEventListener('click', function() {
                fileInput.click();
            });
            
            // æ–‡ä»¶é€‰æ‹©å˜åŒ–
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
            
            // æ‹–æ‹½åŠŸèƒ½
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    handleFile(e.dataTransfer.files[0]);
                }
            });
        });
        
        function handleFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/i)) {
                showStatus('è¯·é€‰æ‹©Excelæ–‡ä»¶ï¼ˆ.xlsx æˆ– .xls æ ¼å¼ï¼‰', 'error');
                return;
            }
            
            showStatus('æ­£åœ¨è¯»å–æ–‡ä»¶...', 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    workbook = XLSX.read(data, {type: 'array'});
                    
                    // æ˜¾ç¤ºç¬¬ä¸€ä¸ªå·¥ä½œè¡¨çš„ä¿¡æ¯
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    
                    if (jsonData.length === 0) {
                        showStatus('Excelæ–‡ä»¶ä¸ºç©º', 'error');
                        return;
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦åŒ…å«å¿…è¦çš„åˆ—
                    const headers = jsonData[0];
                    const hasTaskName = headers.some(h => h && h.toString().toLowerCase().includes('task_name'));
                    const hasParameter = headers.some(h => h && h.toString().toLowerCase().includes('parameter'));
                    const hasResultValue = headers.some(h => h && h.toString().toLowerCase().includes('resultvalue'));
                    const hasSampleID = headers.some(h => h && h.toString().toLowerCase().includes('sample_id'));
                    
                    if (!hasTaskName || !hasParameter) {
                        showStatus('Excelæ–‡ä»¶ä¸­æœªæ‰¾åˆ°Task_Nameå’ŒParameteråˆ—', 'error');
                        return;
                    }
                    
                    if (!hasResultValue) {
                        showStatus('Excelæ–‡ä»¶ä¸­æœªæ‰¾åˆ°ResultValueåˆ—', 'error');
                        return;
                    }
                    
                    if (!hasSampleID) {
                        showStatus('Excelæ–‡ä»¶ä¸­æœªæ‰¾åˆ°Sample_IDåˆ—', 'error');
                        return;
                    }
                    
                    showStatus(`æ–‡ä»¶è¯»å–æˆåŠŸï¼å·¥ä½œè¡¨: ${firstSheetName}, è¡Œæ•°: ${jsonData.length}`, 'success');
                    document.getElementById('processBtn').disabled = false;
                    
                } catch (error) {
                    showStatus('æ–‡ä»¶è¯»å–å¤±è´¥: ' + error.message, 'error');
                }
            };
            
            reader.onerror = function() {
                showStatus('æ–‡ä»¶è¯»å–å¤±è´¥', 'error');
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function processFile() {
            if (!workbook) {
                showStatus('è¯·å…ˆä¸Šä¼ Excelæ–‡ä»¶', 'error');
                return;
            }
            
            showStatus('æ­£åœ¨å¤„ç†æ•°æ®...', 'info');
            
            try {
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                
                if (jsonData.length < 2) {
                    showStatus('æ•°æ®ä¸è¶³ï¼Œè‡³å°‘éœ€è¦è¡¨å¤´å’Œæ•°æ®è¡Œ', 'error');
                    return;
                }
                
                const headers = jsonData[0];
                const dataRows = jsonData.slice(1);
                
                // æ‰¾åˆ°Task_Nameã€Parameterå’ŒResultValueåˆ—çš„ç´¢å¼•
                const taskNameIndex = headers.findIndex(h => h && h.toString().toLowerCase().includes('task_name'));
                const parameterIndex = headers.findIndex(h => h && h.toString().toLowerCase().includes('parameter'));
                const resultValueIndex = headers.findIndex(h => h && h.toString().toLowerCase().includes('resultvalue'));
                
                // æ‰¾åˆ°Sampleç›¸å…³åˆ—çš„ç´¢å¼•
                const sampleIDIndex = headers.findIndex(h => h && h.toString().toLowerCase().includes('sample_id'));
                const sampleNameIndex = headers.findIndex(h => h && h.toString().toLowerCase().includes('sample_name'));
                const measuredConcentrationIndex = headers.findIndex(h => h && h.toString().toLowerCase().includes('measured_concentration'));
                const projectIDIndex = headers.findIndex(h => h && h.toString().toLowerCase().includes('project_id'));
                
                if (taskNameIndex === -1 || parameterIndex === -1) {
                    showStatus('æœªæ‰¾åˆ°Task_Nameæˆ–Parameteråˆ—', 'error');
                    return;
                }
                
                if (resultValueIndex === -1) {
                    showStatus('æœªæ‰¾åˆ°ResultValueåˆ—', 'error');
                    return;
                }
                
                if (sampleIDIndex === -1) {
                    showStatus('æœªæ‰¾åˆ°Sample_IDåˆ—', 'error');
                    return;
                }
                
                // æ”¶é›†æ‰€æœ‰å”¯ä¸€çš„Task_Name_Parameterç»„åˆ
                const uniqueCombinations = new Set();
                
                dataRows.forEach(row => {
                    if (row[taskNameIndex] && row[parameterIndex]) {
                        const combination = `${row[taskNameIndex]}_${row[parameterIndex]}`;
                        uniqueCombinations.add(combination);
                    }
                });
                
                // åˆ›å»ºæ–°çš„è¡¨å¤´ - ä¿ç•™Sampleç›¸å…³åˆ—å’ŒTask_Name_Parameterç»„åˆ
                const newHeaders = ['#'];
                
                // æ·»åŠ Sampleç›¸å…³åˆ—
                if (sampleIDIndex !== -1) newHeaders.push(headers[sampleIDIndex]);
                if (sampleNameIndex !== -1) newHeaders.push(headers[sampleNameIndex]);
                if (measuredConcentrationIndex !== -1) newHeaders.push(headers[measuredConcentrationIndex]);
                if (projectIDIndex !== -1) newHeaders.push(headers[projectIDIndex]);
                
                // æ·»åŠ Task_Name_Parameterç»„åˆåˆ—
                Array.from(uniqueCombinations).forEach(combination => {
                    newHeaders.push(combination);
                });
                
                // æŒ‰Sample_IDåˆ†ç»„æ•°æ®
                const groupedBySample = {};
                
                dataRows.forEach(row => {
                    const sampleID = row[sampleIDIndex];
                    if (!sampleID) return;
                    
                    if (!groupedBySample[sampleID]) {
                        groupedBySample[sampleID] = {
                            sampleID: sampleID,
                            sampleName: sampleNameIndex !== -1 ? row[sampleNameIndex] : '',
                            measuredConcentration: measuredConcentrationIndex !== -1 ? row[measuredConcentrationIndex] : '',
                            projectID: projectIDIndex !== -1 ? row[projectIDIndex] : '',
                            combinations: {}
                        };
                    }
                    
                    // ä¸ºæ¯ä¸ªTask_Name_Parameterç»„åˆå­˜å‚¨ResultValue
                    const combination = `${row[taskNameIndex]}_${row[parameterIndex]}`;
                    if (row[taskNameIndex] && row[parameterIndex] && row[resultValueIndex]) {
                        groupedBySample[sampleID].combinations[combination] = row[resultValueIndex];
                    }
                });
                
                // åˆ›å»ºæ–°çš„æ•°æ®è¡Œ
                const newData = [newHeaders];
                
                // ä¸ºæ¯ä¸ªSample_IDåˆ›å»ºä¸€è¡Œæ•°æ®
                Object.values(groupedBySample).forEach((sampleData, index) => {
                    const newRow = [index + 1]; // æ·»åŠ è‡ªåŠ¨ç¼–å·
                    
                    // æ·»åŠ Sampleç›¸å…³æ•°æ®
                    if (sampleIDIndex !== -1) newRow.push(sampleData.sampleID);
                    if (sampleNameIndex !== -1) newRow.push(sampleData.sampleName);
                    if (measuredConcentrationIndex !== -1) newRow.push(sampleData.measuredConcentration);
                    if (projectIDIndex !== -1) newRow.push(sampleData.projectID);
                    
                    // ä¸ºæ¯ä¸ªTask_Name_Parameterç»„åˆæ·»åŠ å¯¹åº”çš„ResultValue
                    Array.from(uniqueCombinations).forEach(combination => {
                        newRow.push(sampleData.combinations[combination] || '');
                    });
                    
                    newData.push(newRow);
                });
                
                convertedData = newData;
                
                // æ˜¾ç¤ºç»“æœè¡¨æ ¼
                displayResultTable(newHeaders, newData.slice(1));
                
                showStatus(`æ•°æ®å¤„ç†å®Œæˆï¼å…±ç”Ÿæˆ ${uniqueCombinations.size} ä¸ªæ–°åˆ—`, 'success');
                document.getElementById('downloadBtn').disabled = false;
                
            } catch (error) {
                showStatus('æ•°æ®å¤„ç†å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        function displayResultTable(headers, data) {
            const table = document.getElementById('resultTable');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            
            // æ¸…ç©ºè¡¨æ ¼
            thead.innerHTML = '';
            tbody.innerHTML = '';
            
            // åˆ›å»ºè¡¨å¤´
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header || '';
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            
            // åˆ›å»ºæ•°æ®è¡Œ
            data.forEach(rowData => {
                const row = document.createElement('tr');
                rowData.forEach(cell => {
                    const td = document.createElement('td');
                    td.textContent = cell || '';
                    row.appendChild(td);
                });
                tbody.appendChild(row);
            });
            
            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            document.getElementById('resultSection').style.display = 'block';
        }
        
        function downloadExcel() {
            if (!convertedData) {
                showStatus('æ²¡æœ‰å¯ä¸‹è½½çš„æ•°æ®', 'error');
                return;
            }
            
            try {
                // åˆ›å»ºå·¥ä½œè¡¨
                const ws = XLSX.utils.aoa_to_sheet(convertedData);
                
                // è®¾ç½®å•å…ƒæ ¼æ ·å¼
                const range = XLSX.utils.decode_range(ws['!ref']);
                
                // è®¾ç½®æ‰€æœ‰å•å…ƒæ ¼çš„å­—ä½“å’Œå­—å·
                for (let R = range.s.r; R <= range.e.r; ++R) {
                    for (let C = range.s.c; C <= range.e.c; ++C) {
                        const cell_address = {c: C, r: R};
                        const cell_ref = XLSX.utils.encode_cell(cell_address);
                        
                        if (!ws[cell_ref]) continue;
                        
                        // è®¾ç½®å­—ä½“ä¸ºArialï¼Œå­—å·ä¸º8
                        ws[cell_ref].s = {
                            font: {
                                name: 'Arial',
                                sz: 8
                            }
                        };
                    }
                }
                
                // è®¾ç½®åˆ—å®½è‡ªåŠ¨è°ƒæ•´
                const colWidths = [];
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    let maxLength = 0;
                    for (let R = range.s.r; R <= range.e.r; ++R) {
                        const cell_address = {c: C, r: R};
                        const cell_ref = XLSX.utils.encode_cell(cell_address);
                        
                        if (ws[cell_ref]) {
                            const cellValue = ws[cell_ref].v ? ws[cell_ref].v.toString() : '';
                            maxLength = Math.max(maxLength, cellValue.length);
                        }
                    }
                    // æ ¹æ®å†…å®¹é•¿åº¦è®¾ç½®åˆ—å®½ï¼Œæœ€å°å®½åº¦ä¸º8ï¼Œæœ€å¤§å®½åº¦ä¸º50
                    colWidths.push({wch: Math.min(Math.max(maxLength, 8), 50)});
                }
                
                ws['!cols'] = colWidths;
                
                // åˆ›å»ºå·¥ä½œç°¿
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'è½¬æ¢ç»“æœ');
                
                // ç”ŸæˆExcelæ–‡ä»¶å¹¶ä¸‹è½½
                XLSX.writeFile(wb, 'è½¬æ¢ç»“æœ_' + new Date().toISOString().slice(0, 19).replace(/:/g, '-') + '.xlsx');
                
                showStatus('æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼', 'success');
                
            } catch (error) {
                showStatus('ä¸‹è½½å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        function showStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
            
            // 3ç§’åè‡ªåŠ¨éšè—ä¿¡æ¯çŠ¶æ€
            if (type === 'info') {
                setTimeout(() => {
                    if (statusEl.textContent === message) {
                        statusEl.style.display = 'none';
                    }
                }, 3000);
            }
        }
    </script>
</body>
</html>
